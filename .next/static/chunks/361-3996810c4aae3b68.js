(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[361],{9361:function(e,t,n){"use strict";n.d(t,{S:function(){return h}});var o=n(7437),i=n(2265),r=n(7648),s=n(8562),a=n.n(s),l=n(8211),c=n(1310),u=n(126),m=n.n(u);let d=e=>{let{postId:t,onCommentSuccess:n,type:r="REPLY"}=e,[s,a]=(0,i.useState)(""),[l,c]=(0,i.useState)(""),u=async e=>{e.preventDefault(),c("");let o=localStorage.getItem("token");if(!o){c("投稿するにはログインが必要です。");return}if(!s.trim()&&"REPOST"!==r){c("内容を入力してください。");return}try{let e=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(o)},body:JSON.stringify({content:s,type:r,parentId:t})});if(e.ok)a(""),n();else{let t=await e.json();c(t.error||"投稿に失敗しました。")}}catch(e){c("予期せぬエラーが発生しました。")}};return(0,o.jsxs)("form",{onSubmit:u,className:m().commentForm,children:["REPOST"!==r&&(0,o.jsx)("textarea",{value:s,onChange:e=>a(e.target.value),placeholder:"REPLY"===r?"コメントを追加...":"引用コメントを追加...",className:m().textareaField,rows:2,required:"REPOST"!==r}),l&&(0,o.jsx)("p",{className:m().errorMessage,children:l}),(0,o.jsx)("button",{type:"submit",className:m().submitButton,children:"REPLY"===r?"コメント":"QUOTE"===r?"引用投稿":"リポスト"})]})},h=e=>{var t;let{post:n,onPostDeleted:s,currentUserId:u}=e,{showToast:m}=(0,l.p)(),{showPopover:h}=(0,c.t)(),[p,_]=(0,i.useState)(n.likedByCurrentUser),[x,f]=(0,i.useState)(n.likesCount),C=(0,i.useRef)(null),[g,T]=(0,i.useState)(!1),[j,v]=(0,i.useState)(n.children||[]);(0,i.useEffect)(()=>{v(n.children||[])},[n.children]);let b=async(e,t)=>{let n=localStorage.getItem("token");if(!n){m({title:"エラー",description:"コメントを削除するにはログインが必要です。",variant:"error"});return}h({anchorElement:t.currentTarget,title:"確認",description:"このコメントを削除してもよろしいですか？",variant:"warning",onConfirm:async()=>{try{let t=await fetch("/api/comments/".concat(e),{method:"DELETE",headers:{Authorization:"Bearer ".concat(n)}});if(t.ok)m({title:"成功",description:"コメントが削除されました！",variant:"success"}),s&&s();else{let e=await t.json();m({title:"エラー",description:e.error||"コメントの削除に失敗しました。",variant:"error"})}}catch(e){m({title:"エラー",description:"予期せぬエラーが発生しました。",variant:"error"})}},onCancel:()=>{m({title:"キャンセル",description:"コメントの削除をキャンセルしました。",variant:"info"})}})},k=async()=>{let e=localStorage.getItem("token");if(!e){m({title:"エラー",description:"ログインしてください。",variant:"error"});return}try{let t=await fetch("/api/posts/".concat(n.id,"/like"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();_(e.liked),f(e.likesCount)}else{let e=await t.json();m({title:"エラー",description:e.error||"いいねに失敗しました。",variant:"error"})}}catch(e){m({title:"エラー",description:"ネットワークエラーが発生しました。",variant:"error"})}},w=async()=>{if(!window.confirm("本当にこの投稿を削除しますか？"))return;let e=localStorage.getItem("token");if(!e){m({title:"エラー",description:"ログインしてください。",variant:"error"});return}try{let t=await fetch("/api/posts/".concat(n.id),{method:"DELETE",headers:{Authorization:"Bearer ".concat(e)}});if(t.ok)m({title:"成功",description:"投稿を削除しました。",variant:"success"}),s&&s();else{let e=await t.json();m({title:"エラー",description:e.error||"投稿の削除に失敗しました。",variant:"error"})}}catch(e){m({title:"エラー",description:"ネットワークエラーが発生しました。",variant:"error"})}};return(0,o.jsxs)("div",{className:a().postCard,children:[(0,o.jsxs)("div",{className:a().postHeader,children:[(0,o.jsxs)(r.default,{href:"/users/".concat(n.author.id),className:a().postAuthor,children:[n.author.name||"名無しユーザー",n.author.customId&&(0,o.jsxs)("span",{className:a().postAuthorCustomId,children:[" @",n.author.customId]})," "]}),(0,o.jsx)("span",{className:a().postDate,children:new Date(n.createdAt).toLocaleString()})]}),(0,o.jsx)("p",{className:a().postContent,children:(e=>{let t=[],n=0;return e.replace(/@([a-zA-Z0-9_]+)/g,(i,s,l)=>(l>n&&t.push(e.substring(n,l)),t.push((0,o.jsx)(r.default,{href:"/users/@".concat(s),className:a().mentionLink,children:i},l)),n=l+i.length,i)),n<e.length&&t.push(e.substring(n)),t})(n.content)}),(0,o.jsxs)("div",{className:a().postActions,children:[(0,o.jsxs)("button",{onClick:k,className:"".concat(a().likeButton," ").concat(p?a().liked:""),children:["いいね (",x,")"]}),(0,o.jsx)("button",{onClick:()=>T(!g),className:a().commentButton,children:"コメント"}),(0,o.jsx)("button",{ref:C,onClick:()=>{let e="".concat(window.location.origin,"/posts/").concat(n.id);navigator.clipboard.writeText(e).then(()=>{h({title:"成功",description:"投稿URLをコピーしました！",variant:"success",anchorElement:C.current})}).catch(()=>{h({title:"エラー",description:"URLのコピーに失敗しました。",variant:"error",anchorElement:C.current})})},className:a().shareButton,children:"共有"}),u&&n.author.id===u&&(0,o.jsx)("button",{onClick:w,className:a().deleteButton,children:"削除"})]}),g&&(0,o.jsxs)("div",{className:a().commentsSection,children:[(0,o.jsxs)("h4",{className:a().commentsTitle,children:["リプライ (",(null!==(t=n.children)&&void 0!==t?t:[]).filter(e=>"REPLY"===e.type).length||0,")"]}),(null!=j?j:[]).filter(e=>"REPLY"===e.type).length>0?(0,o.jsx)("div",{className:a().commentList,children:(null!=j?j:[]).filter(e=>"REPLY"===e.type).map(e=>(0,o.jsxs)("div",{className:a().commentItem,children:[(0,o.jsx)(r.default,{href:"/users/".concat(e.author.id),className:a().commentAuthor,children:e.author.name||"ユーザー ".concat(e.author.id)}),(0,o.jsx)("span",{className:a().commentDate,children:new Date(e.createdAt).toLocaleString("ja-JP",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"})}),(0,o.jsx)("p",{className:a().commentContent,children:e.content}),u===e.author.id&&(0,o.jsx)("button",{onClick:t=>b(e.id,t),className:a().deleteCommentButton,children:"削除"})]},e.id))}):(0,o.jsx)("p",{className:a().noCommentsMessage,children:"まだリプライがありません。"}),(0,o.jsx)(d,{postId:n.id,onCommentSuccess:()=>{s&&s()}})]})]})}},1310:function(e,t,n){"use strict";n.d(t,{t:function(){return l},u:function(){return a}});var o=n(7437),i=n(2265),r=n(5367);let s=(0,i.createContext)(void 0);function a(e){let{children:t}=e,[n,a]=(0,i.useState)(!1),[l,c]=(0,i.useState)(null),u=(0,i.useRef)(null),m=(0,i.useCallback)(()=>{a(!1),c(null),u.current&&(window.clearTimeout(u.current),u.current=null)},[]),d=(0,i.useCallback)(e=>{let{anchorElement:t,duration:n=3e3,...o}=e;m(),c({...o,anchorElement:t,duration:n}),a(!0),n>0&&(u.current=window.setTimeout(()=>{m()},n))},[m]),h=(0,i.useCallback)(()=>{(null==l?void 0:l.onConfirm)&&l.onConfirm(),m()},[l,m]),p=(0,i.useCallback)(()=>{(null==l?void 0:l.onCancel)&&l.onCancel(),m()},[l,m]),_=l?(e=>{switch(e){case"success":return{bg:"bg-green-500",text:"text-white"};case"error":return{bg:"bg-red-500",text:"text-white"};case"warning":return{bg:"bg-yellow-500",text:"text-gray-900"};default:return{bg:"bg-blue-500",text:"text-white"}}})(l.variant||"info"):{bg:"",text:""};return(0,o.jsxs)(s.Provider,{value:{showPopover:d},children:[t,l&&l.anchorElement&&(0,o.jsxs)(r.fC,{open:n,onOpenChange:a,children:[(0,o.jsx)(r.ee,{asChild:!0,children:(0,o.jsx)("div",{style:{position:"absolute",top:l.anchorElement.getBoundingClientRect().top,left:l.anchorElement.getBoundingClientRect().left,width:l.anchorElement.getBoundingClientRect().width,height:l.anchorElement.getBoundingClientRect().height,pointerEvents:"none"}})}),(0,o.jsx)(r.h_,{children:(0,o.jsxs)(r.VY,{className:"rounded-md shadow-lg p-4 text-sm ".concat(_.bg," ").concat(_.text),sideOffset:5,onOpenAutoFocus:e=>e.preventDefault(),onCloseAutoFocus:e=>e.preventDefault(),children:[(0,o.jsx)("h3",{className:"font-medium",children:l.title}),l.description&&(0,o.jsx)("p",{children:l.description}),(l.onConfirm||l.onCancel)&&(0,o.jsxs)("div",{className:"flex justify-end gap-2 mt-2",children:[l.onCancel&&(0,o.jsx)("button",{onClick:p,className:"px-3 py-1 rounded bg-gray-300 text-gray-800 hover:bg-gray-400",children:"キャンセル"}),l.onConfirm&&(0,o.jsx)("button",{onClick:h,className:"px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700",children:"OK"})]}),(0,o.jsx)(r.Eh,{className:"fill-current text-white"}),(0,o.jsx)("button",{className:"absolute top-1 right-1 p-1 rounded-full hover:bg-opacity-20 focus:outline-none focus:ring-2 focus:ring-opacity-50",onClick:m,children:"✕"})]})})]})]})}function l(){let e=(0,i.useContext)(s);if(void 0===e)throw Error("useClickableToastPopover must be used within a ClickableToastPopoverProvider");return e}},8211:function(e,t,n){"use strict";n.d(t,{V:function(){return a},p:function(){return l}});var o=n(7437),i=n(2265),r=n(5803);let s=(0,i.createContext)(void 0);function a(e){let{children:t}=e,[n,a]=(0,i.useState)(!1),[l,c]=(0,i.useState)({title:"",description:"",variant:"info"}),u=i.useRef(null),m=(0,i.useCallback)(e=>{c(e),a(!0),u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(()=>{a(!1)},3e3)},[]);return(0,o.jsxs)(r.zt,{swipeDirection:"right",children:[(0,o.jsx)(s.Provider,{value:{showToast:m},children:t}),(0,o.jsxs)(r.fC,{open:n,onOpenChange:a,className:"toast ".concat(l.variant),children:[(0,o.jsx)(r.Dx,{children:l.title}),l.description&&(0,o.jsx)(r.dk,{children:l.description})]}),(0,o.jsx)(r.l_,{})]})}function l(){let e=(0,i.useContext)(s);if(void 0===e)throw Error("useToast must be used within a ToastProvider");return e}},126:function(e){e.exports={commentForm:"CommentForm_commentForm__i01GW",textareaField:"CommentForm_textareaField__MwKjj",submitButton:"CommentForm_submitButton__FUJ5s",errorMessage:"CommentForm_errorMessage__5mag3"}},8562:function(e){e.exports={timelineContainer:"Timeline_timelineContainer__WppA0",postCard:"Timeline_postCard__uYZ6G",postHeader:"Timeline_postHeader__HB5Zr",authorLink:"Timeline_authorLink__dEne2",postDate:"Timeline_postDate__rxDpH",postContent:"Timeline_postContent__ykYZl",postActions:"Timeline_postActions__WRJIp",likeButton:"Timeline_likeButton__uGXsZ",deleteButton:"Timeline_deleteButton__aipxl",deleteCommentButton:"Timeline_deleteCommentButton__hPy4n",actionButton:"Timeline_actionButton__Vc6Up",liked:"Timeline_liked__BaUx6",likeIcon:"Timeline_likeIcon__w6slr",noPostsMessage:"Timeline_noPostsMessage__hSXgH",commentsSection:"Timeline_commentsSection__iLyP0",commentsTitle:"Timeline_commentsTitle__pydHp",commentList:"Timeline_commentList__2M_o7",commentItem:"Timeline_commentItem__t3_hZ",commentAuthor:"Timeline_commentAuthor__RmxM7",commentDate:"Timeline_commentDate___0FII",commentContent:"Timeline_commentContent__VXGfn",noCommentsMessage:"Timeline_noCommentsMessage__cuM0l",quotedPost:"Timeline_quotedPost__ysRJM",repostedPost:"Timeline_repostedPost__Jh1if",replyToPost:"Timeline_replyToPost__4xRUq",quotedPostHeader:"Timeline_quotedPostHeader__m4Hb_",repostedPostHeader:"Timeline_repostedPostHeader__XOZdY",quotedPostContent:"Timeline_quotedPostContent__uUycL",repostedPostContent:"Timeline_repostedPostContent__mWZgd",quoteFormContainer:"Timeline_quoteFormContainer__tHgf1",mentionLink:"Timeline_mentionLink__GHGHW",postAuthorCustomId:"Timeline_postAuthorCustomId__rI2Sx"}}}]);