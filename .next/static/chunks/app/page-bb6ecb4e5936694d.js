(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{9256:function(e,t,s){Promise.resolve().then(s.bind(s,7276))},9376:function(e,t,s){"use strict";var a=s(5475);s.o(a,"useRouter")&&s.d(t,{useRouter:function(){return a.useRouter}}),s.o(a,"useSearchParams")&&s.d(t,{useSearchParams:function(){return a.useSearchParams}})},7276:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return j}});var a=s(7437),o=s(2265),n=s(9376),r=s(5760),l=s.n(r);let i=e=>{let{onAuthSuccess:t}=e,[s,n]=(0,o.useState)(!0),[r,i]=(0,o.useState)(""),[c,u]=(0,o.useState)(""),[d,h]=(0,o.useState)(""),[m,p]=(0,o.useState)(""),_=async e=>{e.preventDefault(),p("");let a=s?{email:r,password:c}:{email:r,name:d,password:c};try{let e=await fetch(s?"/api/auth/login":"/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(e.ok){if(s){let t=await e.json();localStorage.setItem("token",t.token)}else{let e=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,password:c})}),t=await e.json();localStorage.setItem("token",t.token)}t()}else{let t=await e.json();p(t.error||"エラーが発生しました。")}}catch(e){p("予期せぬエラーが発生しました。")}};return(0,a.jsxs)("div",{className:l().authFormContainer,children:[(0,a.jsxs)("div",{className:l().tabs,children:[(0,a.jsx)("button",{onClick:()=>n(!0),className:"".concat(l().tabButton," ").concat(s?l().activeTab:""),children:"ログイン"}),(0,a.jsx)("button",{onClick:()=>n(!1),className:"".concat(l().tabButton," ").concat(s?"":l().activeTab),children:"新規登録"})]}),(0,a.jsxs)("form",{onSubmit:_,className:l().form,children:[(0,a.jsx)("h2",{className:l().formTitle,children:s?"ログイン":"新規登録"}),m&&(0,a.jsx)("p",{className:l().errorMessage,children:m}),!s&&(0,a.jsx)("input",{type:"text",placeholder:"名前",value:d,onChange:e=>h(e.target.value),className:l().inputField}),(0,a.jsx)("input",{type:"email",placeholder:"メールアドレス",value:r,onChange:e=>i(e.target.value),required:!0,className:l().inputField}),(0,a.jsx)("input",{type:"password",placeholder:"パスワード",value:c,onChange:e=>u(e.target.value),required:!0,className:l().inputField}),(0,a.jsx)("button",{type:"submit",className:l().submitButton,children:s?"ログイン":"登録"})]})]})};var c=s(7548),u=s.n(c),d=s(8211);let h=e=>{let{onPostSuccess:t}=e,{showToast:s}=(0,d.p)(),[n,r]=(0,o.useState)(""),[l,i]=(0,o.useState)(""),c=async e=>{e.preventDefault(),i("");let a=localStorage.getItem("token");if(!a){i("投稿するにはログインが必要です。"),s({title:"エラー",description:"投稿するにはログインが必要です。",variant:"error"});return}try{let e=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)},body:JSON.stringify({content:n})});if(e.ok)r(""),s({title:"成功",description:"投稿が成功しました！",variant:"success"}),t();else{let t=await e.json();i(t.error||"投稿に失敗しました。"),s({title:"エラー",description:t.error||"投稿に失敗しました。",variant:"error"})}}catch(e){i("予期せぬエラーが発生しました。"),s({title:"エラー",description:"予期せぬエラーが発生しました。",variant:"error"})}};return(0,a.jsxs)("form",{onSubmit:c,className:u().postForm,children:[(0,a.jsx)("textarea",{value:n,onChange:e=>r(e.target.value),placeholder:"今、何を考えていますか？",className:u().textareaField,rows:5,required:!0}),l&&(0,a.jsx)("p",{className:u().errorMessage,children:l}),(0,a.jsx)("button",{type:"submit",className:u().submitButton,children:"投稿"})]})};var m=s(2324),p=s(7408),_=s.n(p);let g=e=>{let{onSetupComplete:t}=e,[s,n]=(0,o.useState)(""),[r,l]=(0,o.useState)(""),[i,c]=(0,o.useState)(""),[u,d]=(0,o.useState)(""),[h,m]=(0,o.useState)(""),p=async e=>{e.preventDefault(),d(""),m("");try{let e=await fetch("/api/admin/setup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,name:i,password:r})});if(e.ok)m("管理者アカウントが正常に作成されました。ログインしてください。"),t();else{let t=await e.json();d(t.error||"管理者アカウントの作成に失敗しました。")}}catch(e){d("予期せぬエラーが発生しました。")}};return(0,a.jsxs)("div",{className:_().adminSetupContainer,children:[(0,a.jsx)("h2",{className:_().title,children:"管理者アカウントの作成"}),(0,a.jsx)("p",{className:_().description,children:"最初のユーザーとして管理者アカウントを作成してください。"}),u&&(0,a.jsx)("p",{className:_().errorMessage,children:u}),h&&(0,a.jsx)("p",{className:_().successMessage,children:h}),(0,a.jsxs)("form",{onSubmit:p,className:_().form,children:[(0,a.jsx)("input",{type:"text",placeholder:"名前 (任意)",value:i,onChange:e=>c(e.target.value),className:_().inputField}),(0,a.jsx)("input",{type:"email",placeholder:"メールアドレス (管理者)",value:s,onChange:e=>n(e.target.value),required:!0,className:_().inputField}),(0,a.jsx)("input",{type:"password",placeholder:"パスワード (管理者)",value:r,onChange:e=>l(e.target.value),required:!0,className:_().inputField}),(0,a.jsx)("button",{type:"submit",className:_().submitButton,children:"管理者アカウントを作成"})]})]})};var f=s(2293),S=s.n(f);function j(){let[e,t]=(0,o.useState)(null),[s,r]=(0,o.useState)([]),[l,c]=(0,o.useState)(void 0),[u,d]=(0,o.useState)("");(0,n.useRouter)();let p=(0,o.useCallback)(async()=>{console.log("fetchPosts called");try{let e=await fetch("/api/posts");if(e.ok){let t=await e.json();r(t)}}catch(e){console.error("Failed to fetch posts:",e)}},[]),_=(0,o.useCallback)(async()=>{console.log("checkUsers called");try{let e=await fetch("/api/admin/check");if(e.ok){let t=await e.json();console.log("checkUsers API response:",t),c(t.hasUsers)}else console.error("Failed to check users:",await e.json()),c(!0)}catch(e){console.error("Error checking users:",e),c(!0)}},[]),f=(0,o.useCallback)(async()=>{console.log("fetchAuthStatus called");let e=localStorage.getItem("token");if(!e){t({loggedIn:!1,userId:null,isAdmin:!1});return}try{let s=await fetch("/api/auth/status",{headers:{Authorization:"Bearer ".concat(e)}});if(s.ok){let e=await s.json();console.log("Auth Status API response:",e),t(e)}else console.error("Failed to fetch auth status:",await s.json()),t({loggedIn:!1,userId:null,isAdmin:!1}),localStorage.removeItem("token")}catch(e){console.error("Error fetching auth status:",e),t({loggedIn:!1,userId:null,isAdmin:!1}),localStorage.removeItem("token")}},[]);(0,o.useEffect)(()=>{console.log("Initial useEffect: Calling checkUsers and fetchPosts"),_(),p()},[_,p]),(0,o.useEffect)(()=>{console.log("Auth Status useEffect: hasUsers=",l),void 0!==l&&f()},[l,f]);let j=async()=>{console.log("handleAdminSetupComplete called"),await _(),f()};return(console.log("Render: hasUsers=",l,"authStatus=",e),void 0===l||null===e)?(0,a.jsx)("div",{className:S().loadingMessage,children:"読み込み中..."}):l?(0,a.jsxs)("div",{className:S().container,children:[(0,a.jsx)("header",{className:S().header,children:(0,a.jsx)("h1",{className:S().title,children:"SNS"})}),(0,a.jsxs)("main",{className:S().mainContent,children:[e.loggedIn?(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:S().sectionTitle,children:"投稿を作成"}),(0,a.jsx)(h,{onPostSuccess:()=>{console.log("handlePostSuccess called"),p()}})]}):(0,a.jsx)("section",{children:(0,a.jsx)(i,{onAuthSuccess:()=>{console.log("handleAuthSuccess called"),f(),p()}})}),(0,a.jsxs)("section",{children:[(0,a.jsx)("h2",{className:S().sectionTitle,children:"タイムライン"}),(0,a.jsx)(m.T,{posts:s,onPostDeleted:p})]})]})]}):(0,a.jsx)(g,{onSetupComplete:j})}},2324:function(e,t,s){"use strict";s.d(t,{T:function(){return u}});var a=s(7437),o=s(2265),n=s(8562),r=s.n(n),l=s(9361),i=s(8211),c=s(1310);let u=e=>{let{posts:t,onPostDeleted:s}=e,{showToast:n}=(0,i.p)(),{showPopover:u}=(0,c.t)(),[d,h]=(0,o.useState)(null),[m,p]=(0,o.useState)(null),[_,g]=(0,o.useState)(null);return((0,o.useEffect)(()=>{let e=localStorage.getItem("token");if(e)try{let t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),s=JSON.parse(window.atob(t));h(s.userId)}catch(e){console.error("トークンのデコードに失敗しました",e),h(null)}},[t]),t&&0!==t.length)?(0,a.jsx)("div",{className:r().timelineContainer,children:t.map(e=>(0,a.jsx)(l.S,{post:e,onPostDeleted:s,currentUserId:d},e.id))}):(0,a.jsx)("div",{className:r().noPostsMessage,children:(0,a.jsx)("p",{children:"まだ投稿がありません。最初の投稿をしてみましょう！"})})}},2293:function(e){e.exports={container:"page_container__aoG4z",header:"page_header__kVzhN",title:"page_title__3jonF",headerNav:"page_headerNav__s8uUQ",searchForm:"page_searchForm__LFzRP",searchInput:"page_searchInput__spYJs",searchButton:"page_searchButton__vE0yS",logoutButton:"page_logoutButton__K4PKs",adminButton:"page_adminButton__Y_ux1",mainContent:"page_mainContent__51TpB",sectionTitle:"page_sectionTitle__hzsAh",loadingMessage:"page_loadingMessage__qCwow"}},7408:function(e){e.exports={adminSetupContainer:"AdminSetupForm_adminSetupContainer__jZRfN",title:"AdminSetupForm_title__IxmHQ",description:"AdminSetupForm_description__tYM2s",errorMessage:"AdminSetupForm_errorMessage__US5jr",successMessage:"AdminSetupForm_successMessage__2vnLZ",form:"AdminSetupForm_form__jYBvN",inputField:"AdminSetupForm_inputField__2DIuC",submitButton:"AdminSetupForm_submitButton__jYpjT"}},5760:function(e){e.exports={authFormContainer:"AuthForm_authFormContainer__9rIw1",tabs:"AuthForm_tabs__eeqHR",tabButton:"AuthForm_tabButton__Je7co",activeTab:"AuthForm_activeTab__N96eK",form:"AuthForm_form__ugvBR",formTitle:"AuthForm_formTitle__lBYAs",errorMessage:"AuthForm_errorMessage__6oozP",inputField:"AuthForm_inputField__MInff",submitButton:"AuthForm_submitButton__nzro7"}},7548:function(e){e.exports={postForm:"PostForm_postForm__bvhhW",textareaField:"PostForm_textareaField__RO987",errorMessage:"PostForm_errorMessage__8GPnr",submitButton:"PostForm_submitButton__S4Vfz"}}},function(e){e.O(0,[370,803,555,361,971,117,744],function(){return e(e.s=9256)}),_N_E=e.O()}]);