"use strict";(()=>{var e={};e.id=380,e.ids=[380],e.modules={3524:e=>{e.exports=require("@prisma/client")},7096:e=>{e.exports=require("bcrypt")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},6162:e=>{e.exports=require("stream")},1764:e=>{e.exports=require("util")},1030:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>N,patchFetch:()=>R,requestAsyncStorage:()=>I,routeModule:()=>y,serverHooks:()=>v,staticGenerationAsyncStorage:()=>j});var s={};t.r(s),t.d(s,{DELETE:()=>w,GET:()=>h,PUT:()=>x,dynamic:()=>f});var n=t(9303),i=t(8716),o=t(670),u=t(7070),a=t(3524),d=t(5456),l=t(7096),p=t.n(l),c=t(9553);let f="force-dynamic",m=new a.PrismaClient;async function h(e,{params:r}){try{let t;let s=r.id;if(!(t=isNaN(parseInt(s))?await m.user.findUnique({where:{customId:s}}):await m.user.findUnique({where:{id:parseInt(s,10)}}))&&s.startsWith("@")&&(t=await m.user.findUnique({where:{customId:s.substring(1)}})),!t)return u.NextResponse.json({error:"User not found"},{status:404});let n=(0,d.b)(e),i=await m.user.findUnique({where:{id:t.id},select:{id:!0,email:n===t.id,name:!0,bio:!0,profileImageUrl:!0,isAdmin:!0,createdAt:!0,customId:!0,posts:{orderBy:{createdAt:"desc"},include:{author:{select:{id:!0,name:!0,customId:!0}},likes:{select:{userId:!0}},_count:{select:{likes:!0}},children:{include:{author:{select:{id:!0,name:!0,customId:!0}}}}}}}});if(!i)return u.NextResponse.json({error:"User not found after selection"},{status:404});let o={...i,posts:i.posts.map(e=>({...e,id:String(e.id),author:{...e.author,id:String(e.author.id)},parentId:e.parentId?String(e.parentId):null,likedByCurrentUser:!1,likesCount:e._count.likes}))};return u.NextResponse.json(o)}catch(e){return console.error("Get user profile error:",e),u.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function x(e,{params:r}){try{let t=parseInt(r.id,10);if(isNaN(t))return u.NextResponse.json({error:"Invalid User ID"},{status:400});let s=(0,d.b)(e),n=(0,d.B)(e);if(!s)return u.NextResponse.json({error:"Unauthorized"},{status:401});if(s!==t&&!n)return u.NextResponse.json({error:"Forbidden: You can only edit your own profile or be an admin"},{status:403});let{name:i,bio:o,profileImageUrl:a,password:l}=await e.json(),f={};if(void 0!==i){if(null!==i){let e=await m.user.findUnique({where:{name:i}});if(e&&e.id!==t)return u.NextResponse.json({error:"このユーザー名はすでに使用されています。"},{status:409})}f.name=(0,c.Z)(i)}if(void 0!==o&&(f.bio=(0,c.Z)(o)),void 0!==a&&(f.profileImageUrl=(0,c.Z)(a)),void 0!==l&&""!==l&&(f.password=await p().hash(l,10)),0===Object.keys(f).length)return u.NextResponse.json({message:"No fields to update"},{status:200});let h=await m.user.update({where:{id:t},data:f,select:{id:!0,email:!0,name:!0,bio:!0,profileImageUrl:!0,isAdmin:!0,createdAt:!0}});return u.NextResponse.json(h)}catch(e){return console.error("Update user profile error:",e),u.NextResponse.json({error:"Internal Server Error"},{status:500})}}async function w(e,{params:r}){try{let t=parseInt(r.id,10);if(isNaN(t))return u.NextResponse.json({error:"Invalid User ID"},{status:400});let s=(0,d.b)(e),n=(0,d.B)(e);if(!s)return u.NextResponse.json({error:"Unauthorized"},{status:401});if(!n)return u.NextResponse.json({error:"Forbidden: Admin access required to delete users"},{status:403});if(s===t)return u.NextResponse.json({error:"Forbidden: Cannot delete your own admin account"},{status:403});if(!await m.user.findUnique({where:{id:t}}))return u.NextResponse.json({error:"User not found"},{status:404});return await m.user.delete({where:{id:t}}),u.NextResponse.json({message:"User deleted successfully"},{status:200})}catch(e){return console.error("Delete user error:",e),u.NextResponse.json({error:"Internal Server Error"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/users/[id]/route",pathname:"/api/users/[id]",filename:"route",bundlePath:"app/api/users/[id]/route"},resolvedPagePath:"C:\\Users\\kazuy\\sns\\src\\app\\api\\users\\[id]\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:I,staticGenerationAsyncStorage:j,serverHooks:v}=y,N="/api/users/[id]/route";function R(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:j})}},5456:(e,r,t)=>{t.d(r,{B:()=>a,b:()=>u});var s=t(1482),n=t.n(s);let i=process.env.JWT_SECRET;if(!i)throw Error("JWT_SECRET is not defined in environment variables.");function o(e){return"object"==typeof e&&null!==e&&"number"==typeof e.userId&&"string"==typeof e.email&&"boolean"==typeof e.isAdmin}function u(e){let r=e.headers.get("authorization"),t=r?.split(" ")?.[1];if(!t)return null;try{let e=n().verify(t,i);if(o(e))return e.userId;return null}catch(e){return null}}function a(e){let r=e.headers.get("authorization"),t=r?.split(" ")?.[1];if(!t)return!1;try{let e=n().verify(t,i);if(o(e))return e.isAdmin;return!1}catch(e){return!1}}},9553:(e,r,t)=>{t.d(r,{Z:()=>o});var s=t(2630);let n=new(require("jsdom")).JSDOM("").window,i=(0,s.Z)(n);function o(e){return i.sanitize(e)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[276,972,482,525],()=>t(1030));module.exports=s})();